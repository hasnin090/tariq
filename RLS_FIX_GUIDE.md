# إصلاح مشاكل Row Level Security والإعدادات

## المشاكل المكتشفة

1. **جدول `settings` غير موجود** - يسبب خطأ 406
2. **سياسات RLS غير مُعرّفة** - تسبب أخطاء 401 و 42501
3. **عدم وجود صلاحيات للمستخدمين المصادقين**

## الحل

### الخطوة 1: تطبيق السكريبت في Supabase

1. افتح **Supabase Dashboard**
2. انتقل إلى **SQL Editor**
3. افتح ملف `fix-rls-and-settings.sql`
4. انسخ المحتوى والصقه في SQL Editor
5. اضغط **Run**

### الخطوة 2: التحقق من النجاح

بعد تشغيل السكريبت، تحقق من:

#### 1. جدول Settings
```sql
SELECT * FROM public.settings;
```
يجب أن ترى 6 صفوف للإعدادات الافتراضية.

#### 2. سياسات RLS
```sql
SELECT schemaname, tablename, policyname 
FROM pg_policies 
WHERE schemaname = 'public';
```
يجب أن ترى سياسة واحدة على الأقل لكل جدول.

#### 3. الصلاحيات
```sql
SELECT grantee, table_name, privilege_type 
FROM information_schema.table_privileges 
WHERE table_schema = 'public' 
AND grantee = 'authenticated';
```

### الخطوة 3: اختبار التطبيق

1. قم بتحديث الصفحة في المتصفح
2. جرب إنشاء مشروع جديد
3. جرب تغيير الإعدادات في صفحة التخصيص

## ما الذي يفعله السكريبت؟

### 1. إنشاء جدول Settings
- يحتوي على الإعدادات الأساسية للنظام
- العملة، الخانات العشرية، معلومات الشركة

### 2. تفعيل RLS
- يفعل Row Level Security على جميع الجداول
- يضمن أمان البيانات

### 3. إنشاء السياسات
- سياسة واحدة لكل جدول
- تسمح لجميع المستخدمين المصادقين بالوصول الكامل
- يمكن تخصيصها لاحقاً حسب الأدوار

### 4. منح الصلاحيات
- يمنح صلاحيات كاملة للمستخدمين المصادقين
- يمنح صلاحية القراءة فقط للإعدادات للمستخدمين المجهولين

## ملاحظات مهمة

⚠️ **تحذير**: هذا السكريبت يمنح صلاحيات واسعة لجميع المستخدمين المصادقين. 

إذا كنت تريد تقييد الصلاحيات حسب الأدوار (Admin, Sales, Accounting)، يمكنك تعديل السياسات لاحقاً.

## استكشاف الأخطاء

### إذا استمرت الأخطاء:

1. **تحقق من تسجيل الدخول**
   ```javascript
   console.log(supabase.auth.getSession());
   ```

2. **تحقق من RLS**
   ```sql
   SELECT * FROM pg_tables WHERE schemaname = 'public' AND rowsecurity = true;
   ```

3. **تحقق من السياسات**
   ```sql
   SELECT * FROM pg_policies WHERE schemaname = 'public';
   ```

## الدعم

إذا واجهت أي مشاكل:
1. تحقق من console المتصفح للأخطاء
2. تحقق من Supabase Logs
3. تأكد من أن المستخدم مسجل دخول بشكل صحيح
