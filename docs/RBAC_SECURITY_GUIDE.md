# ๐ ุฏููู ูุธุงู ุงูุตูุงุญูุงุช ูุงูุญูุงูุฉ (RBAC)

## ูุธุฑุฉ ุนุงูุฉ

ุชู ุชุทุจูู ูุธุงู **Role-Based Access Control (RBAC)** ุดุงูู ูุญูุงูุฉ ุงููุธุงู ูู ุงููุตูู ุบูุฑ ุงููุตุฑุญ ุจู.

## ๐ฏ ุงููุดููุฉ ุงูุชู ุชู ุญููุง

**ุซุบุฑุฉ ุฃูููุฉ ุฎุทูุฑุฉ**: ูุงู ุจุฅููุงู ุงููุณุชุฎุฏููู ุฐูู ุงูุตูุงุญูุงุช ุงููุญุฏูุฏุฉ (Accounting, Sales) ุงููุตูู ุฅูู ุตูุญุงุช ุฅุฏุงุฑูุฉ ุญุณุงุณุฉ ูุซู:
- ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู
- ุฅุฏุงุฑุฉ ุงููุดุงุฑูุน
- ุงูุฅุดุนุงุฑุงุช ุงูุฅุฏุงุฑูุฉ
- ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช

## โ ุงูุญู ุงููุทุจู

### 1. ูุธุงู ุงูุตูุงุญูุงุช ุงููุฑูุฒู (`utils/permissions.ts`)

ููู ุดุงูู ูุญุชูู ุนูู:

#### ุฃ) `ROLE_PAGES` - ุงูุตูุญุงุช ุงููุชุงุญุฉ ููู ุฏูุฑ

```typescript
Admin: 31 ุตูุญุฉ (ูุตูู ูุงูู)
- dashboard, users, projects-management, customers, units...

Accounting: 17 ุตูุญุฉ (ุงููุตุฑููุงุช ูุงูููุฒุงููุงุช)
- expense-dashboard, expenses, treasury, budgets, projects-accounting...

Sales: 9 ุตูุญุงุช (ุงูุนููุงุก ูุงููุจูุนุงุช)
- dashboard, customers, units, bookings, payments...
```

#### ุจ) `ROLE_PERMISSIONS` - ุงูุตูุงุญูุงุช ุงูุชูุตูููุฉ

ุตูุงุญูุงุช CRUD ููู ููุฑุฏ:
- **Admin**: ุตูุงุญูุงุช ูุงููุฉ (View, Edit, Delete, Create) ุนูู ุฌููุน ุงูููุงุฑุฏ
- **Accounting**: ูุญุฏูุฏ ุจุงููุตุฑููุงุช ูุงููุฆุงุช ูุงูููุธููู
- **Sales**: ูุญุฏูุฏ ุจุงูุนููุงุก ูุงููุญุฏุงุช ูุงูุญุฌูุฒุงุช

#### ุฌ) ุฏูุงู ูุณุงุนุฏุฉ

```typescript
canAccessPage(role, pageId)       // ูู ูููู ุงููุตูู ููุตูุญุฉุ
hasPermission(role, resource, action)  // ูู ูููู ุตูุงุญูุฉ ูุญุฏุฏุฉุ
getDefaultPage(role)              // ุงูุตูุญุฉ ุงูุงูุชุฑุงุถูุฉ ููุฏูุฑ
getPermissions(role, resource)    // ุงูุญุตูู ุนูู ุฌููุน ุงูุตูุงุญูุงุช
filterByAssignedProject(user, data)  // ููุชุฑุฉ ุงูุจูุงูุงุช ุญุณุจ ุงููุดุฑูุน ุงููุฎุตุต
```

### 2. ูููู ุญูุงูุฉ ุงููุณุงุฑุงุช (`ProtectedRoute.tsx`)

ูููู React ูููุฑ **3 ุทุจูุงุช ุฃูุงู**:

#### ุงูุทุจูุฉ 1: ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู
```tsx
if (!currentUser) โ ุนุฑุถ ุดุงุดุฉ "ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู"
```

#### ุงูุทุจูุฉ 2: ุงูุชุญูู ูู ุงูุฏูุฑ
```tsx
<ProtectedRoute allowedRoles={['Admin']}>
  <Users />
</ProtectedRoute>
```
ุฅุฐุง ูู ููู ุงููุณุชุฎุฏู Admin โ ุนุฑุถ "ุบูุฑ ูุตุฑุญ ุจุงููุตูู"

#### ุงูุทุจูุฉ 3: ุงูุชุญูู ูู ุงูุตูุงุญูุฉ ุนูู ููุฑุฏ ูุญุฏุฏ
```tsx
<ProtectedRoute resource="users" action="delete">
  <DeleteButton />
</ProtectedRoute>
```

### 3. ุชุญุฏูุซุงุช ุนูู ุงููููุงุช ุงูุฑุฆูุณูุฉ

#### `App.tsx`
- โ ุงุณุชูุฑุงุฏ `canAccessPage` ู `getDefaultPage`
- โ ุงูุชุญูู ูู ุงูุตูุงุญูุฉ ูุจู ุนุฑุถ ุฃู ุตูุญุฉ
- โ ุฅุนุงุฏุฉ ุงูุชูุฌูู ููุตูุญุฉ ุงูุงูุชุฑุงุถูุฉ ุฅุฐุง ุญุงูู ุงููุตูู ูุตูุญุฉ ุบูุฑ ูุตุฑุญ ุจูุง
- โ ุญูุงูุฉ ุงูุตูุญุงุช ุงูุญุณุงุณุฉ ุจู `<ProtectedRoute>`

```tsx
case 'users': 
  return (
    <ProtectedRoute allowedRoles={['Admin']}>
      <Users />
    </ProtectedRoute>
  );
```

#### `Sidebar.tsx`
- โ ุงุณุชูุฑุงุฏ `canAccessPage`
- โ ููุชุฑุฉ ุงูููุงุฆู ุญุณุจ ุงูุตูุงุญูุงุช
```typescript
linksToShow = projectsLinks.filter(link => 
  currentUser && canAccessPage(currentUser.role, link.page)
);
```

#### `Notifications.tsx`
- โ ููุชุฑุฉ ุงูุฅุดุนุงุฑุงุช ุญุณุจ ุงูุฏูุฑ
  - **Admin**: ูุฑู ุฌููุน ุงูุฅุดุนุงุฑุงุช
  - **Accounting/Sales**: ูุฑู ุฅุดุนุงุฑุงุชู ุงูุฎุงุตุฉ ููุท

## ๐ก๏ธ ุงูุตูุญุงุช ุงููุญููุฉ

### ุตูุญุงุช Admin ููุท:
1. โ **Users** - ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู
2. โ **Projects Management** - ุฅุฏุงุฑุฉ ุงููุดุงุฑูุน
3. โ **Customization** - ุชุฎุตูุต ุงููุธุงู
4. โ **Data Import** - ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช
5. โ **Project User Management** - ุฑุจุท ุงููุดุงุฑูุน ุจุงููุณุชุฎุฏููู

### ุงูุฅุดุนุงุฑุงุช:
- โ Admin: ุฌููุน ุงูุฅุดุนุงุฑุงุช
- โ Accounting/Sales: ุงูุฅุดุนุงุฑุงุช ุงูุดุฎุตูุฉ ููุท

## ๐ ุฌุฏูู ุงูุตูุงุญูุงุช ุงููุงูู

| ุงูุฏูุฑ | ุงูุตูุญุงุช | ุงููุณุชุฎุฏููู | ุงููุดุงุฑูุน | ุงูุนููุงุก | ุงููุญุฏุงุช | ุงูุญุฌูุฒุงุช | ุงููุตุฑููุงุช | ุงูุชูุงุฑูุฑ |
|------|---------|------------|----------|---------|---------|----------|-----------|----------|
| **Admin** | 31 | โ Full | โ Full | โ Full | โ Full | โ Full | โ Full | โ Full |
| **Accounting** | 17 | โ | โ View | โ | โ | โ | โ Full | โ View |
| **Sales** | 9 | โ | โ View | โ Full | โ Full | โ Full | โ | โ View |

## ๐งช ุงุฎุชุจุงุฑ ุงููุธุงู

### 1. ุงุฎุชุจุงุฑ ุฏูุฑ Admin
```
โ ุณุฌู ุฏุฎูู ูู Admin
โ ุชุญูู ูู ุฅููุงููุฉ ุงููุตูู ูุฌููุน ุงูุตูุญุงุช
โ ุชุญูู ูู ุธููุฑ ุฌููุน ุงูููุงุฆู ูู Sidebar
โ ุชุญูู ูู ุฑุคูุฉ ุฌููุน ุงูุฅุดุนุงุฑุงุช
```

### 2. ุงุฎุชุจุงุฑ ุฏูุฑ Accounting
```
โ ุณุฌู ุฏุฎูู ูู Accounting
โ ุชุญูู ูู ุนุฏู ุธููุฑ Users ูู ุงููุงุฆูุฉ
โ ุญุงูู ุงููุตูู ูุฏููุงู ูู /users โ ูุฌุจ ุฃู ูุธูุฑ "ุบูุฑ ูุตุฑุญ"
โ ุชุญูู ูู ุฑุคูุฉ ุงูุฅุดุนุงุฑุงุช ุงูุดุฎุตูุฉ ููุท
โ ุชุญูู ูู ุฅููุงููุฉ ุงููุตูู ูู expense-dashboard
```

### 3. ุงุฎุชุจุงุฑ ุฏูุฑ Sales
```
โ ุณุฌู ุฏุฎูู ูู Sales
โ ุชุญูู ูู ุนุฏู ุธููุฑ ุตูุญุงุช ุงููุตุฑููุงุช
โ ุชุญูู ูู ุฅููุงููุฉ ุงููุตูู ูู customers, units, bookings
โ ุญุงูู ุงููุตูู ูู /expenses โ ูุฌุจ ุฃู ูุธูุฑ "ุบูุฑ ูุตุฑุญ"
```

## ๐ ููููุฉ ุฅุถุงูุฉ ุตูุญุฉ ูุญููุฉ ุฌุฏูุฏุฉ

### 1. ุฅุถุงูุฉ ุงูุตูุญุฉ ูู `permissions.ts`
```typescript
export const ROLE_PAGES: Record<UserRole, string[]> = {
  Admin: [...existingPages, 'new-page'],
  Accounting: [...existingPages, 'new-page'], // ุฅุฐุง ูุงู Accounting ูุณุชุทูุน ุงููุตูู
  Sales: [...existingPages],
};
```

### 2. ุฅุถุงูุฉ ุงูุตูุงุญูุงุช ุงูุชูุตูููุฉ
```typescript
export const ROLE_PERMISSIONS: Record<UserRole, Record<string, Permission>> = {
  Admin: {
    // ...
    'new-resource': { canView: true, canEdit: true, canDelete: true, canCreate: true },
  },
  Accounting: {
    // ...
    'new-resource': { canView: true, canEdit: false, canDelete: false, canCreate: false },
  },
};
```

### 3. ุญูุงูุฉ ุงูุตูุญุฉ ูู `App.tsx`
```tsx
case 'new-page': 
  return (
    <ProtectedRoute allowedRoles={['Admin', 'Accounting']}>
      <NewPage />
    </ProtectedRoute>
  );
```

### 4. ุฅุถุงูุฉ ุงูุฑุงุจุท ูู `Sidebar.tsx`
```typescript
const defaultProjectsLinks = [
  // ...
  { icon: <NewIcon />, label: 'ุตูุญุฉ ุฌุฏูุฏุฉ', page: 'new-page', adminOnly: false },
];
```

## ๐ ุฅุญุตุงุฆูุงุช ุงููุธุงู

- **ุงูุตูุญุงุช ุงููุญููุฉ**: 5 ุตูุญุงุช ุฅุฏุงุฑูุฉ
- **ุงูุฃุฏูุงุฑ ุงููุฏุนููุฉ**: 3 (Admin, Accounting, Sales)
- **ุงูููุงุฑุฏ ุงููุญุฏุฏุฉ**: 20+ ููุฑุฏ
- **ุงูุตูุงุญูุงุช**: 4 ุฃููุงุน (View, Edit, Delete, Create)
- **ุทุจูุงุช ุงูุฃูุงู**: 3 ุทุจูุงุช

## โ๏ธ ููุงุญุธุงุช ุฃูููุฉ ูููุฉ

1. โ **ูุง ุชุนุชูุฏ ููุท ุนูู ุฅุฎูุงุก ุงููุงุฌูุงุช** - ุงููุธุงู ูุชุญูู ูู ุงูุตูุงุญูุงุช ุนูู ูุณุชูู ุงููุณุงุฑุงุช
2. โ **ุงูููุชุฑุฉ ุนูู ูุณุชูู ุงูุฎุงุฏู** - ุชุฃูุฏ ูู ุชุทุจูู RLS ูู Supabase ุฃูุถุงู
3. โ **ุงูุชุญูู ูู ุงูุตูุงุญูุงุช ูุจู ุฃู ุนูููุฉ** - ุงุณุชุฎุฏู `hasPermission()` ูุจู ุฃู ุนูููุฉ ุญุณุงุณุฉ
4. โ **ุชุณุฌูู ูุญุงููุงุช ุงููุตูู ุบูุฑ ุงููุตุฑุญ** - ูููู ุฅุถุงูุฉ activity log ูููุญุงููุงุช ุงููุงุดูุฉ

## ๐ ุงูุชุญุฏูุซุงุช ุงููุณุชูุจููุฉ

- [ ] ุฅุถุงูุฉ ุตูุงุญูุงุช ุนูู ูุณุชูู ุงูุตููู (Row-Level Security)
- [ ] ุชุณุฌูู ูุญุงููุงุช ุงููุตูู ุบูุฑ ุงููุตุฑุญ ูู activity log
- [ ] ุฅุถุงูุฉ ุตูุญุฉ ุฅุฏุงุฑุฉ ุงูุตูุงุญูุงุช ููู Admin
- [ ] ุฏุนู ุงูุตูุงุญูุงุช ุงูุฏููุงููููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- [ ] ุฅุถุงูุฉ session timeout ููุฃูุงู

## ๐ ุงูุฎูุงุตุฉ

ุชู ุชุทุจูู ูุธุงู RBAC ุดุงูู ููุชูุงูู ูุญูู ุงููุธุงู ูู:
- โ ุงููุตูู ุบูุฑ ุงููุตุฑุญ ููุตูุญุงุช ุงูุฅุฏุงุฑูุฉ
- โ ุนุฑุถ ุจูุงูุงุช ุญุณุงุณุฉ ูููุณุชุฎุฏููู ุบูุฑ ุงููุตุฑุญ ููู
- โ ุชูููุฐ ุนูููุงุช ุจุฏูู ุตูุงุญูุงุช
- โ ุงุณุชุบูุงู ุงูุซุบุฑุงุช ุงูุฃูููุฉ

**ุงููุธุงู ุงูุขู ุขูู ููุญูู ุจุงููุงูู! ๐**
