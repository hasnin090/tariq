# ๐ ุฏููู ูุธุงู ุงูุฏูุน ุงูุฅุถุงูู ูุงููุฑููุงุช

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅุถุงูุฉ ูุธุงู ุดุงูู ูุฅุฏุงุฑุฉ **ุงูุฏูุนุงุช ุงูุฅุถุงููุฉ** ู**ูุฑููุงุช ุงูุฏูุน** ูู ูุธุงู ุงูุฃูุณุงุทุ ููุง ูููุฑ ูุฑููุฉ ุฃูุจุฑ ููุนููุงุก ููุญุณู ูู ุชูุซูู ุนูููุงุช ุงูุฏูุน.

---

## ๐ฏ ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ

### 1๏ธโฃ **ูุธุงู ุฑูุน ุงููุฑููุงุช ููุฏูุนุงุช**

#### โจ ุงููุตู
- ุนูุฏ ุงูุถุบุท ุนูู ุฒุฑ "ุชุณุฏูุฏ ุงูุฏูุนุฉ"ุ ุชุธูุฑ ูุงูุฐุฉ ูุฑูุน ูุฑูู (ุฅูุตุงู/ูุงุชูุฑุฉ)
- ุฑูุน ุงููุฑูู **ุงุฎุชูุงุฑู** - ูููู ุงูุชุฎุทู ูุงููุชุงุจุนุฉ ุจุฏูู ูุฑูู
- ูุฏุนู ุฃููุงุน ูููุงุช ูุชุนุฏุฏุฉ: ุตูุฑุ PDFุ Word
- ุญุฏ ุฃูุตู ูุญุฌู ุงูููู: **10MB**

#### ๐ ุณูุฑ ุงูุนูู
```
ุงูุถุบุท ุนูู "ุชุณุฏูุฏ" โ ูุงูุฐุฉ ุฑูุน ุงููุฑูู โ ุฑูุน ุงูููู (ุงุฎุชูุงุฑู) โ ุฅููุงู ุงูุชุณุฏูุฏ โ
```

#### ๐ ุงูุชุฎุฒูู
- ุงููุฑููุงุช ุชูุญูุธ ูู **Supabase Storage**
- ูุชู ุฅูุดุงุก bucket ุจุงุณู `payment-attachments` ุชููุงุฆูุงู
- ูู ูุฑูู ูุฑุชุจุท ุจุฏูุนุฉ ูุญุฏุฏุฉ ูู ุฌุฏูู `payment_attachments`

---

### 2๏ธโฃ **ูุธุงู ุงูุฏูุน ุงูุฅุถุงูู (ุฎุงุฑุฌ ุงูุฌุฏูู)**

#### โจ ุงููุตู
- ุงูุณูุงุญ ููุนููู ุจุฏูุน ูุจูุบ ุฅุถุงูู **ุฎุงุฑุฌ ุงูุฃูุณุงุท ุงููุฌุฏููุฉ**
- ุงููุธุงู ูุนูุฏ ุญุณุงุจ ุงููุจูุบ ุงููุชุจูู ูููุฏู ุฎูุงุฑุงุช ูุฅุนุงุฏุฉ ุงูุฌุฏููุฉ

#### ๐๏ธ ุฎูุงุฑุงุช ุฅุนุงุฏุฉ ุงูุฌุฏููุฉ

##### **1. ุชููุงุฆู (Auto)**
- ุชูุฒูุน ุงููุจูุบ ุงููุชุจูู ุนูู ุนุฏุฏ ุงูุฃูุณุงุท ุงููุนููุฉ ุงูุญุงููุฉ
- ุญุณุงุจ ุชููุงุฆู ููุจูุบ ุงููุณุท ุงูุฌุฏูุฏ
- **ูุซุงู:**
  ```
  ุงููุจูุบ ุงููุชุจูู: 100,000 ุฑ.ุณ
  ุงูุฃูุณุงุท ุงููุนููุฉ: 10 ุฃูุณุงุท
  โ ุงููุณุท ุงูุฌุฏูุฏ: 10,000 ุฑ.ุณ ููู ูุณุท
  ```

##### **2. ูุฏูู (Manual)**
- ุฅุนุงุฏุฉ ุฅูุดุงุก ุฌุฏูู ุฏูุนุงุช ุฌุฏูุฏ ุจุงููุงูู
- ุงููุณุชุฎุฏู ูุฎุชุงุฑ:
  - ุนุฏุฏ ุงูุฃูุณุงุท ุงูุฌุฏูุฏ
  - ุงููุชุฑุฉ ุงูุฒูููุฉ (ููููุ ุฃุณุจูุนูุ ุดูุฑูุ ุณููู)
  - ุชุงุฑูุฎ ุงูุจุฏุงูุฉ
- **ูุซุงู:**
  ```
  ุงููุจูุบ ุงููุชุจูู: 100,000 ุฑ.ุณ
  ุนุฏุฏ ุงูุฃูุณุงุท ุงูุฌุฏูุฏ: 5 ุฃูุณุงุท
  ุงููุชุฑุฉ: ุดูุฑู
  โ ุงููุณุท ุงูุฌุฏูุฏ: 20,000 ุฑ.ุณ ุดูุฑูุงู
  ```

#### ๐ก ุญุงูุฉ ุฎุงุตุฉ
- ุฅุฐุง ูุงู ุงููุจูุบ ุงููุฏููุน **โฅ ุงููุจูุบ ุงููุชุจูู**:
  - ูุชู ุชุณุฏูุฏ ุฌููุน ุงูุฃูุณุงุท ุงููุนููุฉ ุชููุงุฆูุงู โ
  - ูุง ุญุงุฌุฉ ูุฅุนุงุฏุฉ ุงูุฌุฏููุฉ

---

## ๐๏ธ ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ุงูุฌุฏุงูู ุงูุฌุฏูุฏุฉ

#### 1. `payment_attachments`
```sql
CREATE TABLE payment_attachments (
    id TEXT PRIMARY KEY,
    payment_id TEXT NOT NULL REFERENCES scheduled_payments(id),
    file_name TEXT NOT NULL,
    file_path TEXT NOT NULL,
    file_size INTEGER,
    file_type TEXT,
    uploaded_by TEXT,
    uploaded_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 2. `extra_payments`
```sql
CREATE TABLE extra_payments (
    id TEXT PRIMARY KEY,
    unit_sale_id TEXT NOT NULL REFERENCES unit_sales(id),
    customer_id TEXT NOT NULL REFERENCES customers(id),
    amount DECIMAL(15,2) NOT NULL,
    payment_date DATE NOT NULL,
    payment_method TEXT,
    notes TEXT,
    reschedule_type TEXT CHECK (reschedule_type IN ('auto', 'manual')),
    new_installment_count INTEGER,
    new_installment_period TEXT,
    attachment_id TEXT REFERENCES payment_attachments(id)
);
```

#### 3. ุชุญุฏูุซ `scheduled_payments`
```sql
ALTER TABLE scheduled_payments 
ADD COLUMN attachment_id TEXT REFERENCES payment_attachments(id);
```

---

### ุงูุฏูุงู ุงูุฌุฏูุฏุฉ

#### 1. `calculate_remaining_balance_after_extra_payment`
ุญุณุงุจ ุงููุจูุบ ุงููุชุจูู ุจุนุฏ ุงูุฏูุนุฉ ุงูุฅุถุงููุฉ

```sql
SELECT * FROM calculate_remaining_balance_after_extra_payment(
    'unit_sale_id',
    5000.00 -- ูุจูุบ ุงูุฏูุนุฉ ุงูุฅุถุงููุฉ
);
```

#### 2. `auto_reschedule_payments`
ุฅุนุงุฏุฉ ุฌุฏููุฉ ุชููุงุฆูุฉ ููุฏูุนุงุช ุงููุชุจููุฉ

```sql
SELECT auto_reschedule_payments(
    'unit_sale_id',
    'extra_payment_id'
);
```

#### 3. `manual_reschedule_payments`
ุฅุนุงุฏุฉ ุฌุฏููุฉ ูุฏููุฉ ูุน ูุนุงููุฑ ุฌุฏูุฏุฉ

```sql
SELECT manual_reschedule_payments(
    'unit_sale_id',
    50000.00,  -- ุงููุจูุบ ุงููุชุจูู
    5,         -- ุนุฏุฏ ุงูุฃูุณุงุท ุงูุฌุฏูุฏ
    'monthly', -- ุงููุชุฑุฉ
    '2025-02-01' -- ุชุงุฑูุฎ ุงูุจุฏุงูุฉ
);
```

---

## ๐๏ธ ุงููููุงุช ุงูุฌุฏูุฏุฉ

### 1. Migration
```
๐ supabase-migrations/
  โโโ add-payment-attachments-and-extra-payments.sql
```

### 2. ุงูุฎุฏูุงุช
```
๐ src/services/
  โโโ storageService.ts  (ุฎุฏูุฉ ุฑูุน ูุฅุฏุงุฑุฉ ุงููุฑููุงุช)
```

### 3. ุงูููููุงุช
```
๐ components/shared/
  โโโ PaymentAttachmentModal.tsx  (ูุงูุฐุฉ ุฑูุน ุงููุฑููุงุช)
  โโโ ExtraPaymentModal.tsx       (ูุงูุฐุฉ ุงูุฏูุน ุงูุฅุถุงูู)
```

### 4. ุงูุชุญุฏูุซุงุช
```
๐ components/pages/sales/
  โโโ ScheduledPayments.tsx  (ุชู ุชุญุฏูุซู)
```

---

## ๐ ุงูุชุดุบูู ูุงูุงุณุชุฎุฏุงู

### 1. ุชุทุจูู Migration
```bash
# ุชุดุบูู Migration ูู Supabase
psql -h <host> -U <user> -d <database> -f supabase-migrations/add-payment-attachments-and-extra-payments.sql
```

ุฃู ุจุงุณุชุฎุฏุงู Supabase CLI:
```bash
supabase migration up
```

### 2. ุฅุนุฏุงุฏ Supabase Storage
- ุณูุชู ุฅูุดุงุก bucket `payment-attachments` ุชููุงุฆูุงู ุนูุฏ ุฃูู ุฑูุน
- ุฃู ููููู ุฅูุดุงุคู ูุฏููุงู ูู ููุญุฉ Supabase:
  ```
  Storage โ Create bucket โ payment-attachments
  ```

### 3. ุงูุงุณุชุฎุฏุงู ูู ุงููุงุฌูุฉ

#### ุชุณุฏูุฏ ุฏูุนุฉ ุนุงุฏูุฉ:
1. ุงูุชูู ุฅูู **ุตูุญุฉ ุงูุฏูุนุงุช ุงููุฌุฏููุฉ**
2. ุงุถุบุท ุนูู ุฒุฑ **"ุชุณุฏูุฏ"** ูููุณุท ุงููุฑุงุฏ ุฏูุนู
3. **ูุงูุฐุฉ ุฑูุน ุงููุฑูู** ุณุชุธูุฑ:
   - ุงุฎุชุฑ ููู (ุงุฎุชูุงุฑู)
   - ุฃู ุงุถุบุท **"ุชุฎุทู"**
4. ุณูุชู ุชุณุฌูู ุงูุฏูุนุฉ โ

#### ุฅุถุงูุฉ ุฏูุนุฉ ุฅุถุงููุฉ:
1. ูู **ุตูุญุฉ ุงูุฏูุนุงุช ุงููุฌุฏููุฉ**
2. ุงุฎุชุฑ ุญุฌุฒ ูู ุงููุงุฆูุฉ ุงูููุณุฏูุฉ
3. ุณูุธูุฑ ุฒุฑ **"ุฏูุน ุฅุถุงูู"**
4. ูู ุงููุงูุฐุฉ:
   - ุฃุฏุฎู ุงููุจูุบ
   - ุงุฎุชุฑ ุทุฑููุฉ ุงูุฏูุน
   - ุงุฎุชุฑ ููุน ุฅุนุงุฏุฉ ุงูุฌุฏููุฉ (ุชููุงุฆู/ูุฏูู)
   - ุฅุฐุง ุงุฎุชุฑุช ูุฏููุ ุญุฏุฏ ุงููุนุงููุฑ ุงูุฌุฏูุฏุฉ
5. ุงุถุบุท **"ุชุฃููุฏ ุงูุฏูุน"**

---

## ๐ ุฃูุซูุฉ ุนูููุฉ

### ูุซุงู 1: ุฏูุน ุนุงุฏู ูุน ูุฑูู
```
ุงูุนููู: ุฃุญูุฏ ูุญูุฏ
ุงููุณุท #3: 5,000 ุฑ.ุณ
โ ุชุณุฏูุฏ โ ุฑูุน ุฅูุตุงู ุงูุจูู (PDF) โ ุฅุชูุงู โ
```

### ูุซุงู 2: ุฏูุน ุฅุถุงูู - ุฅุนุงุฏุฉ ุฌุฏููุฉ ุชููุงุฆูุฉ
```
ุงููุจูุบ ุงููุชุจูู: 50,000 ุฑ.ุณ
ุงูุฃูุณุงุท ุงููุนููุฉ: 10 ุฃูุณุงุท
ุงูุฏูุนุฉ ุงูุฅุถุงููุฉ: 10,000 ุฑ.ุณ
โ ุงููุชุจูู ุงูุฌุฏูุฏ: 40,000 ุฑ.ุณ
โ ุงููุณุท ุงูุฌุฏูุฏ: 4,000 ุฑ.ุณ (ุชูุฒูุน ุชููุงุฆู)
```

### ูุซุงู 3: ุฏูุน ุฅุถุงูู - ุฅุนุงุฏุฉ ุฌุฏููุฉ ูุฏููุฉ
```
ุงููุจูุบ ุงููุชุจูู: 50,000 ุฑ.ุณ
ุงูุฏูุนุฉ ุงูุฅุถุงููุฉ: 20,000 ุฑ.ุณ
โ ุงููุชุจูู ุงูุฌุฏูุฏ: 30,000 ุฑ.ุณ
โ ุงุฎุชูุงุฑ: 3 ุฃูุณุงุท ุดูุฑูุฉ
โ ุงููุณุท ุงูุฌุฏูุฏ: 10,000 ุฑ.ุณ ุดูุฑูุงู
```

### ูุซุงู 4: ุชุณุฏูุฏ ูุงูู
```
ุงููุจูุบ ุงููุชุจูู: 15,000 ุฑ.ุณ
ุงูุฏูุนุฉ ุงูุฅุถุงููุฉ: 20,000 ุฑ.ุณ
โ ุชุณุฏูุฏ ูุงูู! โ
โ ุฌููุน ุงูุฃูุณุงุท ุงููุนููุฉ ุชู ุชุญุฏูุซูุง ูู "ูุฏููุนุฉ"
```

---

## ๐ ุงูุฃูุงู ูุงูุตูุงุญูุงุช

### RLS (Row Level Security)
- ุฌููุน ุงูุฌุฏุงูู ุงูุฌุฏูุฏุฉ ูุญููุฉ ุจู RLS
- ุงูุณูุงุณุงุช ุงูุญุงููุฉ ุชุณูุญ ููุฌููุน (ูููู ุชุฎุตูุตูุง ูุงุญูุงู)

### ุงูุชุญูู ูู ุงููููุงุช
- ุฃููุงุน ุงููููุงุช ุงููุณููุญุฉ: `image/*, application/pdf, .doc, .docx`
- ุงูุญุฏ ุงูุฃูุตู ููุญุฌู: **10MB**
- ุชุดููุฑ ุงูุงุชุตุงู ุนุจุฑ HTTPS

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงููุดููุฉ: ูุง ูุธูุฑ ุฒุฑ "ุฏูุน ุฅุถุงูู"
**ุงูุญู:** ุชุฃูุฏ ูู ุงุฎุชูุงุฑ ุญุฌุฒ ูู ุงููุงุฆูุฉ ุงูููุณุฏูุฉ

### ุงููุดููุฉ: ูุดู ุฑูุน ุงููุฑูู
**ุงูุญู:** 
- ุชุญูู ูู ุญุฌู ุงูููู (< 10MB)
- ุชุฃูุฏ ูู ููุน ุงูููู ุงููุฏุนูู
- ุชุญูู ูู ุงุชุตุงู ุงูุฅูุชุฑูุช

### ุงููุดููุฉ: ุฎุทุฃ ูู ุฅุนุงุฏุฉ ุงูุฌุฏููุฉ
**ุงูุญู:**
- ุชุญูู ูู ูุฌูุฏ ุฃูุณุงุท ูุนููุฉ
- ุชุฃูุฏ ูู ุตุญุฉ ุงููุจูุบ ุงููุฏุฎู
- ุฑุงุฌุน console ููุชูุงุตูู

---

## ๐ ููุงุญุธุงุช ูููุฉ

1. **ุฑูุน ุงููุฑูู ุงุฎุชูุงุฑู** - ูุง ูููู ุนูููุฉ ุงูุชุณุฏูุฏ
2. **ุงูุฏูุน ุงูุฅุถุงูู ูุง ููุบู ุงูุฃูุณุงุท ุงูุณุงุจูุฉ** - ููุท ูุนูุฏ ุชูุฒูุน ุงููุชุจูู
3. **ุฅุนุงุฏุฉ ุงูุฌุฏููุฉ ุงููุฏููุฉ ุชุญุฐู ุงูุฃูุณุงุท ุงููุนููุฉ ุงููุฏููุฉ** ูุชูุดุฆ ุฌุฏูู ุฌุฏูุฏ
4. **ุงููุฑููุงุช ุชูุญูุธ ูุน ูุนูููุงุช ูุงููุฉ** (ุงูุญุฌูุ ุงูููุนุ ุงูุชุงุฑูุฎุ ุงูุฑุงูุน)

---

## ๐ ุงูุชุญุฏูุซุงุช ุงููุณุชูุจููุฉ ุงูููุชุฑุญุฉ

- [ ] ุฅุถุงูุฉ ูุนุงููุฉ ูููุฑููุงุช ุงููุฑููุนุฉ
- [ ] ุชุญููู ุงููุฑููุงุช ูู ุงููุงุฌูุฉ
- [ ] ุชูุงุฑูุฑ ุงูุฏูุนุงุช ุงูุฅุถุงููุฉ
- [ ] ุฅุดุนุงุฑุงุช ุนูุฏ ุงูุฏูุน ุงูุฅุถุงูู
- [ ] ุชุตุฏูุฑ ุณุฌู ุงูุฏูุนุงุช ุงูุฅุถุงููุฉ

---

## ๐จโ๐ป ุงูุฏุนู ุงูููู

ูููุณุงุนุฏุฉ ุฃู ุงูุฅุจูุงุบ ุนู ูุดุงููุ ูุฑุฌู ูุฑุงุฌุนุฉ:
- ููู ุงููุดุงูู ุงููุนุฑููุฉ
- ุณุฌูุงุช ุงูุฃุฎุทุงุก ูู console
- ุชูุงุตู ูุน ูุฑูู ุงูุชุทููุฑ

---

โจ **ุชู ุชุทููุฑ ูุฐุง ุงููุธุงู ูุชุญุณูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู ูุชูููุฑ ูุฑููุฉ ุฃูุจุฑ ูู ุฅุฏุงุฑุฉ ุงูุฏูุนุงุช!**
