# ๐ ุฏููู ุชุดุบูู Migrations - ุงูุชุฑุชูุจ ุงูุตุญูุญ

> **๐ ุงูุชุงุฑูุฎ:** 10 ุฏูุณูุจุฑ 2025  
> **โ ุงูุญุงูุฉ:** ุฌุงูุฒ ููุชูููุฐ

---

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุฐุง ุงูุฏููู ูุดุฑุญ ุงูุชุฑุชูุจ ุงูุตุญูุญ ูุชุดุบูู ูููุงุช Migration ููุงุนุฏุฉ ุงูุจูุงูุงุช.

---

## ๐ฏ ุงูุชุฑุชูุจ ุงูุตุญูุญ

### 1๏ธโฃ ุงููุฑุญูุฉ ุงูุฃููู: ุงูุฌุฏุงูู ุงูุฃุณุงุณูุฉ

**ุงูููู:** `00-create-base-tables.sql`

**ูุงุฐุง ููุนู:**
- โ ุฅูุดุงุก 15 ุฌุฏูู ุฃุณุงุณู
- โ ุฅูุดุงุก ุฌููุน ุงูููุงุฑุณ (Indexes)
- โ ุฅุฏุฑุงุฌ ุงูุจูุงูุงุช ุงูุงูุชุฑุงุถูุฉ

**ุงูุฌุฏุงูู:**
```
projects, users, notifications, unit_types, unit_statuses,
accounts, customers, units, employees, bookings, payments,
documents, expenses, transactions, activity_logs
```

**ููู ุชุดุบููู:**
1. ุงูุชุญ Supabase Dashboard โ SQL Editor
2. ุงูุณุฎ ูุญุชูู `00-create-base-tables.sql`
3. ุงูุตู ูู SQL Editor
4. ุงุถุบุท RUN โถ๏ธ
5. ุงูุชุธุฑ ุฑุณุงูุฉ ุงููุฌุงุญ โ

---

### 2๏ธโฃ ุงููุฑุญูุฉ ุงูุซุงููุฉ: ุฅุนุงุฏุฉ ููููุฉ ุงูุฏูุนุงุช

**ุงูููู:** `restructure-payments-table.sql`

**ูุงุฐุง ููุนู:**
- โ ุชูุธูู ุงูุจูุงูุงุช ุงูุฎุงุทุฆุฉ ุชููุงุฆูุงู
- โ ุฏูุฌ ุฏูุนุงุช ุงูุญุฌุฒ ูุน ุงูุฏูุนุงุช ุงูุฅุถุงููุฉ
- โ ุฅูุดุงุก View: `payments_with_details`
- โ ุฅูุดุงุก Functions ููุญุณุงุจุงุช
- โ ุฅูุดุงุก Triggers ููุญูุงูุฉ ุงูุชููุงุฆูุฉ

**Triggers ุงููููุดุฃุฉ:**
1. `validate_payment_amount` - ููุน ุชุฌุงูุฒ ุณุนุฑ ุงููุญุฏุฉ
2. `update_unit_on_full_payment` - ุชุญุฏูุซ ุญุงูุฉ ุงููุญุฏุฉ ุนูุฏ ุงูุฏูุน ุงููุงูู
3. `update_unit_on_booking_cancel` - ุชุญุฏูุซ ุญุงูุฉ ุงููุญุฏุฉ ุนูุฏ ุงูุฅูุบุงุก
4. `update_*_timestamp` - ุชุญุฏูุซ updated_at ุชููุงุฆูุงู

**ููู ุชุดุบููู:**
1. ุชุฃูุฏ ูู ูุฌุงุญ ุงููุฑุญูุฉ ุงูุฃููู
2. ุงูุชุญ SQL Editor
3. ุงูุณุฎ ูุญุชูู `restructure-payments-table.sql`
4. ุงูุตู ูู SQL Editor
5. ุงุถุบุท RUN โถ๏ธ
6. ุงูุชุธุฑ ุฑุณุงุฆู NOTICE ุงูุชูุถูุญูุฉ

---

### 3๏ธโฃ ุงููุฑุญูุฉ ุงูุซุงูุซุฉ: ุฅุตูุงุญ ุงููุญุฏุงุช

**ุงูููู:** `fix-booked-units-without-active-bookings.sql`

**ูุงุฐุง ููุนู:**
- โ ุฅุตูุงุญ ุงููุญุฏุงุช ุงููุญุฌูุฒุฉ ุจุฏูู ุญุฌุฒ ูุดุท
- โ ุชุญุฏูุซ ุงูุญุงูุฉ ุฅูู "ูุชุงุญ"

**ููู ุชุดุบููู:**
1. ุชุฃูุฏ ูู ูุฌุงุญ ุงููุฑุญูุฉ ุงูุซุงููุฉ
2. ุงูุชุญ SQL Editor
3. ุงูุณุฎ ูุญุชูู ุงูููู
4. ุดุบูู ุงูุฎุทูุฉ 1 ุฃููุงู (ุนุฑุถ ุงููุญุฏุงุช ุงููุชุฃุซุฑุฉ)
5. ุฑุงุฌุน ุงููุชูุฌุฉ
6. ุดุบูู ุงูุฎุทูุฉ 2 (ุงูุชุตุญูุญ)

---

## ๐ ูููุงุช ุงุฎุชูุงุฑูุฉ

### `01-cleanup-invalid-payments.sql` (ุงุฎุชูุงุฑู)

**ูุชู ุชุณุชุฎุฏูู:**
- ุฅุฐุง ุฃุฑุฏุช ูุฑุงุฌุนุฉ ุงูุจูุงูุงุช ูุฏููุงู ูุจู ุงูุชุตุญูุญ
- ุฅุฐุง ูุดู `restructure-payments-table.sql`

**ููุงุญุธุฉ:** ุบูุฑ ูุทููุจ ุนุงุฏุฉู - ุงูููู ุงูุฑุฆูุณู ููุธู ุชููุงุฆูุงู

---

## โ ุงูุชุญูู ูู ุงููุฌุงุญ

### ุจุนุฏ ุงููุฑุญูุฉ ุงูุฃููู:
```sql
-- ุนุฑุถ ุฌููุน ุงูุฌุฏุงูู
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public'
ORDER BY table_name;
-- ูุฌุจ ุฃู ุชุฑู 15 ุฌุฏูู
```

### ุจุนุฏ ุงููุฑุญูุฉ ุงูุซุงููุฉ:
```sql
-- ุนุฑุถ Triggers
SELECT trigger_name, event_object_table 
FROM information_schema.triggers 
WHERE trigger_schema = 'public';

-- ุนุฑุถ Views
SELECT table_name 
FROM information_schema.views 
WHERE table_schema = 'public';

-- ุนุฑุถ Functions
SELECT routine_name 
FROM information_schema.routines 
WHERE routine_schema = 'public';
```

### ุงุฎุชุจุงุฑ ุงูุญูุงูุฉ:
```sql
-- ูุญุงููุฉ ุฅุถุงูุฉ ุฏูุนุฉ ุฃูุจุฑ ูู ุงูุณุนุฑ (ูุฌุจ ุฃู ุชูุดู)
INSERT INTO payments (id, booking_id, amount, payment_date)
VALUES ('test', 'booking_id', 999999999, NOW());
-- ูุฌุจ ุฃู ูุฑูุถ ููุนุทู ุฎุทุฃ ูุงุถุญ
```

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### โ ุฎุทุฃ: "table already exists"
**ุงูุณุจุจ:** ุงูุฌุฏูู ููุฌูุฏ ุจุงููุนู  
**ุงูุญู:** ูุง ูุดููุฉ! ุงูููู ูุณุชุฎุฏู `IF NOT EXISTS`  
**ุงูุฅุฌุฑุงุก:** ุชุงุจุน ุจุฏูู ููู

### โ ุฎุทุฃ: "foreign key violation"
**ุงูุณุจุจ:** ุงููููุงุช ูู ุชูุดุบููู ุจุงูุชุฑุชูุจ ุงูุตุญูุญ  
**ุงูุญู:** ุดุบูู ุงููููุงุช ุจุงูุชุฑุชูุจ ูู 1 ุฅูู 3

### โ ุฎุทุฃ: "ุฅุฌูุงูู ุงูุฏูุนุงุช ูุชุฌุงูุฒ ุณุนุฑ ุงููุญุฏุฉ"
**ุงูุณุจุจ:** ุจูุงูุงุช ุฎุงุทุฆุฉ ููุฌูุฏุฉ  
**ุงูุญู:** ุงูููู ุณูุตูุญูุง ุชููุงุฆูุงู - ุชุงุจุน ุงูุชูููุฐ

### โ ุฎุทุฃ: "column does not exist"
**ุงูุณุจุจ:** ุงููุฑุญูุฉ ุงูุฃููู ูู ุชูุชูู  
**ุงูุญู:** ุชุฃูุฏ ูู ูุฌุงุญ `00-create-base-tables.sql` ุฃููุงู

---

## ๐ก๏ธ ูุตุงุฆุญ ุงูุฃูุงู

### โ๏ธ ูุจู ุงูุจุฏุก:
1. **ูุณุฎุฉ ุงุญุชูุงุทูุฉ:** ุฎุฐ ูุณุฎุฉ ูู ุงูุจูุงูุงุช
2. **ุงูุชูููุช:** ุดุบูู ูู ููุช ูููู ุงูุงุณุชุฎุฏุงู
3. **ุงูุงุฎุชุจุงุฑ:** ุฌุฑูุจ ุนูู ุจูุฆุฉ ุชุทููุฑ ุฃููุงู (ุฅู ุฃููู)

### โ ุจุนุฏ ุงูุงูุชูุงุก:
1. **ุงูุชุญูู:** ุชุฃูุฏ ูู ูุฌุงุญ ุฌููุน ุงูุฎุทูุงุช
2. **ุงูุงุฎุชุจุงุฑ ุงููุธููู:** ุฌุฑูุจ ุฅุถุงูุฉ ุญุฌุฒ ูุฏูุนุฉ
3. **ุงููุฑุงูุจุฉ:** ุฑุงูุจ ุงููุธุงู ููุฏุฉ ููู

---

## ๐ ููุฎุต ุณุฑูุน

```
00-create-base-tables.sql
   โ
   โ 15 ุฌุฏูู ุชู ุฅูุดุงุคูุง
   โ
restructure-payments-table.sql
   โ
   โ ูุธุงู ุงูุฏูุนุงุช ูุญุฏูุซ
   โ Triggers ูุนูุงูุฉ
   โ
fix-booked-units-without-active-bookings.sql
   โ
   โ ุงููุญุฏุงุช ูุตูุญุฉ
   โ
๐ ุงููุธุงู ุฌุงูุฒ!
```

---

## ๐ ุงููุฑุงุฌุน

- **ุงูุชูุซูู ุงููุงูู:** `DATABASE_COMPLETE_SCHEMA.md`
- **ุดุฑุญ ุฅุตูุงุญ ุงูุฏูุนุงุช:** `MIGRATION_FIX_PAYMENTS.md`
- **ุงูุฌุฏุงูู ุงููุงูุตุฉ:** ุฑุงุฌุน ุงููุณู 5 ูู `DATABASE_COMPLETE_SCHEMA.md`

---

## ๐ฏ ุงูุฎูุงุตุฉ

ุจุนุฏ ุชุทุจูู ูุฐู ุงูุฎุทูุงุช ุจุงูุชุฑุชูุจ:

โ **ูุงุนุฏุฉ ุงูุจูุงูุงุช:**
- 15 ุฌุฏูู ุฌุงูุฒ
- ุฌููุน ุงูุนูุงูุงุช (Foreign Keys) ุตุญูุญุฉ
- ุงูููุงุฑุณ ูููุดุฃุฉ ููุฃุฏุงุก ุงูุฃูุซู

โ **ุงูุญูุงูุฉ ุงูุชููุงุฆูุฉ:**
- ููุน ุชุฌุงูุฒ ุณุนุฑ ุงููุญุฏุฉ
- ุชุญุฏูุซ ุญุงูุฉ ุงููุญุฏุงุช ุชููุงุฆูุงู
- ุชุชุจุน ุงูููุช (updated_at)

โ **ุงููุธุงุฆู ุงููุชูุฏูุฉ:**
- ุญุณุงุจ ุงูุฅุฌูุงูู ุงููุฏููุน
- ุญุณุงุจ ุงููุชุจูู
- ุนุฑุถ ุดุงูู ููุฏูุนุงุช

---

**โจ ุงููุธุงู ุงูุขู ุฌุงูุฒ ููุนูู!**
