# ุชูุธูู ุชุฎุฒูู ุงููุณุชูุฏุงุช ูู Supabase Storage

## ๐ ูููู ุงูุชุฎุฒูู ุงูุฌุฏูุฏ

### ูุจู ุงูุชุญุฏูุซ (โ):
```
documents/
โโโ 1767731268015_f234hfz.jpg
โโโ 1767731265176_fzx5r6yai.pdf
โโโ 1767731266444_ob1x6n4.png
โโโ 1767731266449_tvsgdcq.jpg
```
**ุงููุดุงูู:**
- ุฃุณูุงุก ุนุดูุงุฆูุฉ ูุง ุชุนูุณ ุงููุญุชูู
- ูู ุงููุณุชูุฏุงุช ูู ูุฌูุฏ ูุงุญุฏ
- ุชุฏุงุฎู ุจูู ูุณุชูุฏุงุช ุงููุดุงุฑูุน ุงููุฎุชููุฉ
- ุตุนูุจุฉ ุชุชุจุน ุงููููุงุช

### ุจุนุฏ ุงูุชุญุฏูุซ (โ):
```
documents/
โโโ general/                          # ูุณุชูุฏุงุช ุบูุฑ ูุฑุชุจุทุฉ ุจูุดุฑูุน
โ   โโโ 1767731268015_receipt_123.jpg
โ   โโโ 1767731266449_invoice_456.pdf
โ
โโโ project-id-1/                     # ูุณุชูุฏุงุช ุงููุดุฑูุน ุงูุฃูู
โ   โโโ 1767731265176_contract.pdf
โ   โโโ 1767731266444_payment_proof.png
โ
โโโ project-id-2/                     # ูุณุชูุฏุงุช ุงููุดุฑูุน ุงูุซุงูู
    โโโ 1767731268022_expense_receipt.jpg
    โโโ 1767731268028_document.pdf
```

## ๐ฏ ุงููุฒุงูุง ุงูุฌุฏูุฏุฉ

### 1. **ุฃุณูุงุก ูููุงุช ูุงุถุญุฉ:**
```typescript
// ุงููุฏูู:
fileName = `${timestamp}_${randomStr}.${fileExt}`
// ูุซุงู: 1767731268015_f234hfz.jpg

// ุงูุฌุฏูุฏ:
fileName = `${timestamp}_${sanitizedFileName}`
// ูุซุงู: 1767731268015_receipt_from_supplier.jpg
```

### 2. **ุชูุธูู ุญุณุจ ุงููุดุงุฑูุน:**
- ูู ูุดุฑูุน ูู ูุฌูุฏ ูููุตู
- ุณูููุฉ ุชุตูุญ ูููุงุช ูุดุฑูุน ูุนูู
- ุชุฌูุจ ุงูุชุฏุงุฎู ุจูู ุงููุดุงุฑูุน
- ุฅููุงููุฉ ุญุฐู ูู ูููุงุช ูุดุฑูุน ุจุณูููุฉ

### 3. **ุงูุงุญุชูุงุธ ุจุงูุงุณู ุงูุฃุตูู:**
- ุงูุงุณู ุงูุฃุตูู ูุญููุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (`file_name`)
- ุงูุงุณู ุงูุฃุตูู ููุฌูุฏ ูู ุงุณู ุงูููู ุงููุนูู (ุจุนุฏ ุงูุชูุธูู)
- ุณูููุฉ ุงูุจุญุซ ูุงูุชุนุฑู ุนูู ุงููููุงุช

## ๐ง ุงูุชูุงุตูู ุงูุชูููุฉ

### ุฏุงูุฉ ุงูุฑูุน ุงููุญุฏุซุฉ:
```typescript
async upload(file: File, linkedTo: { 
  project_id?: string | null 
  // ... other fields
}) {
  // ุชูุธูู ุงุณู ุงูููู ูู ุงูุฃุญุฑู ุงูุฎุงุตุฉ
  const sanitizedFileName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
  
  // ุฅุถุงูุฉ timestamp ูุชุฌูุจ ุงูุชูุฑุงุฑ
  const fileName = `${timestamp}_${sanitizedFileName}`;
  
  // ุชุญุฏูุฏ ุงููุฌูุฏ ุญุณุจ ุงููุดุฑูุน
  const projectFolder = linkedTo.project_id || 'general';
  
  // ุงููุณุงุฑ ุงูููุงุฆู ูู Storage
  const filePath = `${projectFolder}/${fileName}`;
  
  // ุฑูุน ุงูููู
  await supabase.storage.from('documents').upload(filePath, file);
  
  // ุญูุธ ุงูุจูุงูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
  await supabase.from('documents').insert({
    file_name: file.name,        // ุงูุงุณู ุงูุฃุตูู
    storage_path: filePath,       // ุงููุณุงุฑ ุงููุงูู ูู Storage
    project_id: linkedTo.project_id
  });
}
```

### ูุงุนุฏุฉ ุงูุจูุงูุงุช:
```sql
documents table:
โโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ file_name   โ storage_path     โ project_id                               โ
โโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ receipt.jpg โ project-1/       โ project-1                                โ
โ             โ 1767731268015_   โ                                          โ
โ             โ receipt.jpg      โ                                          โ
โโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ ุฃูุซูุฉ ุงูุงุณุชุฎุฏุงู

### ุฑูุน ูุณุชูุฏ ูุฑุชุจุท ุจูุดุฑูุน:
```typescript
await documentsService.upload(file, {
  expense_id: 'expense_123',
  project_id: 'project_456',
  allow_unlinked: false
});
// ุงููุชูุฌุฉ: documents/project_456/1767731268015_receipt.jpg
```

### ุฑูุน ูุณุชูุฏ ุบูุฑ ูุฑุชุจุท ุจูุดุฑูุน:
```typescript
await documentsService.uploadUnlinkedDocument(
  'invoice.pdf',
  base64Content,
  'application/pdf',
  null
);
// ุงููุชูุฌุฉ: documents/general/1767731268015_invoice.pdf
```

## ๐ ุงูุชุฑุญูู ูู ุงููุธุงู ุงููุฏูู

**ููุงุญุธุฉ:** ุงููุณุชูุฏุงุช ุงููุฏููุฉ ุณุชุจูู ูู ุงููุฌูุฏ ุงูุฑุฆูุณูุ ููู:
- ุชุนูู ุจุดูู ุทุจูุนู (backward compatible)
- ุงููุณุชูุฏุงุช ุงูุฌุฏูุฏุฉ ููุท ุชุณุชุฎุฏู ุงููุธุงู ุงูุฌุฏูุฏ
- ูููู ุชุฑุญูู ุงููุณุชูุฏุงุช ุงููุฏููุฉ ูุงุญูุงู ุฅุฐุง ูุฒู ุงูุฃูุฑ

## ๐ก๏ธ ุงูุฃูุงู

### RLS Policies:
ุชุฃูุฏ ูู ูุฌูุฏ ุณูุงุณุงุช ุงูุฃูุงู ุงูุชุงููุฉ ูู Supabase:

```sql
-- ุงูุณูุงุญ ุจูุฑุงุกุฉ ุงููุณุชูุฏุงุช ุญุณุจ ุงููุดุฑูุน
CREATE POLICY "Users can read project documents"
ON storage.objects FOR SELECT
TO authenticated
USING (
  bucket_id = 'documents' AND
  (
    -- Admin ูุฑู ูู ุดูุก
    auth.uid() IN (SELECT id FROM users WHERE role = 'admin') OR
    -- ุงููุณุชุฎุฏู ูุฑู ูุณุชูุฏุงุช ูุดุฑูุนู ููุท
    (storage.foldername(name))[1] = (
      SELECT assigned_project_id::text 
      FROM users 
      WHERE id = auth.uid()
    )
  )
);
```

## ๐ ุฃูุถู ุงูููุงุฑุณุงุช

1. **ุฏุงุฆูุงู ูุฑุฑ `project_id` ุนูุฏ ุฑูุน ุงููุณุชูุฏุงุช**
2. **ุงุณุชุฎุฏู ุฃุณูุงุก ูููุงุช ูุตููุฉ ููุงุถุญุฉ**
3. **ุชุฌูุจ ุงูุฃุญุฑู ุงูุฎุงุตุฉ ูู ุฃุณูุงุก ุงููููุงุช**
4. **ูุง ุชุญุฐู ุงููุฌูุฏุงุช ูุฏููุงู ูู Storage**

## ๐ ุงุณุชุนูุงูุงุช ูููุฏุฉ

### ุนุฏุฏ ุงููุณุชูุฏุงุช ููู ูุดุฑูุน:
```sql
SELECT 
  project_id,
  COUNT(*) as document_count
FROM documents
WHERE project_id IS NOT NULL
GROUP BY project_id;
```

### ุญุฌู ุงูุชุฎุฒูู ููู ูุดุฑูุน:
```sql
SELECT 
  d.project_id,
  p.name as project_name,
  COUNT(d.id) as file_count,
  SUM(LENGTH(s.metadata->>'size')::int) as total_size_bytes
FROM documents d
JOIN storage.objects s ON s.name = d.storage_path
LEFT JOIN projects p ON p.id = d.project_id
GROUP BY d.project_id, p.name;
```

## ๐ ุงูุชุญุฏูุซุงุช ุงููุณุชูุจููุฉ

- [ ] ุฅุถุงูุฉ ุถุบุท ุชููุงุฆู ููุตูุฑ ุงููุจูุฑุฉ
- [ ] ุฅููุงููุฉ ุฃุฑุดูุฉ ูุณุชูุฏุงุช ุงููุดุงุฑูุน ุงูููุชููุฉ
- [ ] ุชูุงุฑูุฑ ุงุณุชููุงู ุงูุชุฎุฒูู ููู ูุดุฑูุน
- [ ] ูุณุฎ ุงุญุชูุงุทู ุฏูุฑู ููุฌูุฏุงุช ุงููุดุงุฑูุน
